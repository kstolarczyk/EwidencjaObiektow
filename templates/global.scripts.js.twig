{% trans_default_domain 'App' %}
$.fn.disable = function () {
    $(this).prop("disabled", true);
};

$.fn.enable = function () {
    $(this).prop("disabled", false);
};

$.fn.ajaxDataTable = function (url, data, dtOptions) {
    let thCols = $(this).find("thead th");
    let defOptions = {
        serverSide: true,
        ajax: {
            url: url,
            data: function (readyData) {
                readyData['order'] = readyData['order'].reduce(function (map, obj) {
                    let key = thCols.eq(obj.column)[0].dataset.key;
                    map[key] = obj.dir;
                    return map;
                }, {});
                return Object.assign(readyData, data);
            }
        },
        columnDefs: [
            {
                targets: 'custom-class',
                createdCell: function (cell, cellData, rowData, row, col) {
                    let th = thCols.eq(col)[0];
                    let customClass = th.dataset.class;
                    $(cell).addClass(customClass);
                }
            },
            {
                targets: 'custom-render',
                data: null,
                render: function (data, type, row, meta) {
                    let th = thCols.eq(meta.col)[0];
                    let render = th.dataset.render;
                    return window[render](row);
                }
            },
            {
                targets: '_all',
                data: function (row, type, set, meta) {
                    let th = thCols.eq(meta.col)[0];
                    let key = th.dataset.key;
                    return row[key] ? row[key] : '';
                }
            }
        ]
    };
    return $(this).DataTable(Object.assign(defOptions, dtOptions));
};

$(document).on("shown.bs.modal", ".modal", function () {
    $(this).find(":focusable:not(button)").first().focus();
});

$(document).ajaxStart(function () {
    let buttons = $(".btn:not(.ajax-disabled)");
    buttons.addClass("ajax-disabled");
    buttons.disable();
});
$(document).ajaxStop(function () {
    let buttons = $(".ajax-disabled");
    buttons.removeClass("ajax-disabled");
    buttons.enable();
});

$(document).ajaxComplete(function (event, xhr) {
    switch (xhr.status) {
        case 404:
            error({
                text: "{{ 'Nie.odnaleziono.obiektu'|trans }}"
            });
            break;
        case 500:
            error({
                text: "{{ 'Nieoczekiwany.blad.aplikacji'|trans }}"
            });
            break;
        case 403:
            error({
                text: "{{ 'Odmowa.dostepu'|trans }}"
            });
            window.location.reload();
            break;
    }
});