{% trans_default_domain 'App' %}
{{ form_start(form) }}
<div class="row">
    <div class="col-12">
        {{ form_row(form.nazwa) }}
    </div>
</div>
<div class="row">
    <div class="col-12">
        {{ form_row(form.symbol) }}
    </div>
</div>
<div class="row">
    <div class="col-12">
        {{ form_row(form.grupa) }}
    </div>
</div>
<div id="obiekt-parametry-content" data-prototype="{{ form_row(form.parametry.vars.prototype)|e('html_attr') }}">
    {{ form_row(form.parametry) }}
</div>
<div class="row">
    <div class="col-12">
        {{ form_errors(form.dlugosc) }}
        <div id="map" style="height:300px;"></div>
    </div>
</div>
{{ form_row(form.dlugosc) }}
{{ form_row(form.szerokosc) }}
{{ form_end(form) }}

<script>
    $(function () {
        let coords = {
            lat: {{ form.vars.value.szerokosc ?: gmap_default_lat }},
            lng: {{ form.vars.value.dlugosc ?: gmap_default_lon }} };
        let map = $("#map").initMapSingleMarker(coords);
        {% if form.vars.value.szerokosc %}
        map.setMarkers([{position: coords}]);
        {% endif %}
        map.addEventListener('click', function () {
            let coords = this.markers[0];
            $("#obiekt_szerokosc").val(coords.position.lat);
            $("#obiekt_dlugosc").val(coords.position.lng);
        });
    });

    $("select").select2({
        allowClear: false,
        width: '100%'
    });
    $("#obiekt_grupa").select2({
        allowClear: true,
        placeholder: "{{ 'Wybierz.grupe'|trans }}...",
        width: '100%'
    }).change(function () {
        let id = $(this).val();
        let contentElement = $("#obiekt-parametry-content");
        contentElement.html("");
        if (id <= 0) return;
        $.get("{{ path('typ_parametru_ajax') }}", {grupaId: id}, function (response, status) {
            if (status === "success") {
                let formFactor = contentElement.data("prototype");
                $.each(response, function (i, typ) {
                    let label = typ.nazwa + (typ.jednostkaMiary ? " [" + typ.jednostkaMiary + "]" : "");
                    let html = formFactor.replace(/__name__/g, i).replace("__label__", label);
                    if (typ.typDanych === '{{ enum_type }}') {
                        html = html.replace('input', 'select');
                        contentElement.append(html);
                        $("#obiekt_parametry_" + i + "_value").select2({
                            allowClear: false,
                            width: '100%',
                            data: typ.akceptowalneWartosci
                        });
                    } else {
                        contentElement.append(html);
                    }
                    $("#obiekt_parametry_" + i + "_typ").val(typ.id);
                });
            }
        });
    });
</script>